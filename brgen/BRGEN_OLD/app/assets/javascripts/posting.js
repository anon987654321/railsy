$.posting = {
  optimisticPosting: function(options) {
    var form = options.form;

    form.off('submit').on('submit', function(event) {
      event.preventDefault();

      var formData = new FormData(form.get()[0]);

      $.posting.addPhotosToForm(form, formData);

      // NProgress.start();

      $.ajax({
        url: form.attr('action'),
        type: 'post',
        data: formData,
        processData: false,
        contentType: false,
        dataType: 'script',
        success: function(html, textStatus, xhr) {
          // console.log('Ajax submit succeeded');

          if(options.formType === 'topic') {
            $.posting.resetForm({
              form: form,
              formType: 'topic'
            });
          } else if(options.formType === 'reply') {
            $.posting.resetForm({
              form: form,
              formType: 'reply'
            });
          }
        },
        error: function(xhr, textStatus, errorThrown) {
          console.log(textStatus, errorThrown);

          // TODO: Inform the user via flash

          // TODO: Reopen new topic form w/ shaking effect

          /* -------------------------------------------------- */

          // Retry on 504 Gateway Timeout

          // if(textStatus == 'timeout') {
          //   $.posting.optimisticPosting(...);
          //
          //   console.log('504 Gateway Timeout - retrying Ajax submit');
          // }
        }
      });

      /* -------------------------------------------------- */

      // Optimistic posting

      // http://goo.gl/MPySJ8

      var newPost, userTextareaFromForm, newUserTextarea;

      // Clone new post

      if(options.formType === 'topic') {
        topicTemplate = globalVar.activePage.find('.topic').first();

        // New topics should go to the top of the page

        var newTopic = topicTemplate.clone(true).insertBefore(topicTemplate);

        newPost = newTopic.find('.first_post');

        /* -------------------------------------------------- */

        // Class `topic_subject` is generated by Simple Form

        var titleFromForm = form.find('.topic_subject input').val(),
          newTitle = newPost.find('.title');

        newTitle.text(titleFromForm);

        /* -------------------------------------------------- */

        // Mimick Rails' `parameterize` method

        // http://github.com/madflow/jquery-slugify

        var slugifiedCategory = $.slugify(form.find('.selectize-input .item').text()),
          slugifiedUrl = $.slugify(newTitle.text().replace(/'/g, ''));

        newTitle.attr('href', slugifiedCategory + '/' + slugifiedUrl);

        /* -------------------------------------------------- */

        // Store body text for later

        // Class `topic_posts_text` is generated by Simple Form

        userTextareaFromForm = form.find('.topic_posts_text textarea').val();

        /* -------------------------------------------------- */

        // Wipe any old data

        newTopic.removeClass('has_embed_preview');

        newPost.find('.embed_preview').remove()
          .find('.photos').remove()
          .find('.thumbnails').remove()
          .find('.replies').remove();

        /* -------------------------------------------------- */

        var newAttachments = form.find('.photos img, .photos video');

        if(newAttachments.length) {
          var newAttachmentsDiv = $('<div class="photos" />').insertAfter(newPost);

          newAttachment.appendTo(newAttachmentsDiv);
        }

        /* -------------------------------------------------- */

        // TODO: Topic ID for post options

        /* -------------------------------------------------- */

        // Reinitialize form labels

        newPost.find('.new_reply label').inFieldLabels();

        /* -------------------------------------------------- */

        // Close form

        if(!GLOBAL_CONFIG.isMobile) {
          globalVar.activePage.find('.new_topic_expanded').slideUp({
            complete: function() {
              globalVar.activePage.find('.new_topic_trigger').slideDown();
            }
          });
        }
      } else if(options.formType === 'reply') {
        var closestTopic = form.closest('.topic .first_post'),
          replies = closestTopic.find('.replies');

        if(!replies.length) {
          replies = $('<div class="replies" />').appendTo(closestTopic);
        }

        // New replies should go to the bottom of the topic

        newPost = globalVar.replyTemplate.clone(true).appendTo(replies);

        // Class `post_text` is generated by Simple Form

        userTextareaFromForm = form.find('.post_text input').val();
      }

      /* -------------------------------------------------- */

      var originalAvatar = globalVar.activePage.find('.who_am_i .avatar'),
        newPostAvatar = newPost.find('.avatar');

      // Copy to new destination

      $(newPostAvatar).attr('src', originalAvatar.attr('src'));

      /* -------------------------------------------------- */

      var newUserTextarea = newPost.find('.user_textarea');

      newUserTextarea.empty();

      // Mimic Rails' `simple_format` helper

      // https://goo.gl/6NiWjz

      function simpleFormat(text) {
        var carriage_returns, paragraphs, newlines;

        carriage_returns = /\r\n?/g;
        paragraphs = /\n\n+/g;
        newlines = /([^\n]\n)(?=[^\n])/g;

        text.replace(carriage_returns, '\n')
          .replace(paragraphs, '</p><p>')
          .replace(newlines, '$1<br/>');

        return '<p>' + text + '</p>';
      }

      var newUserTextareaParagraphs = simpleFormat(userTextareaFromForm);

      // Copy to new destination

      $(newUserTextareaParagraphs).appendTo(newUserTextarea);

      /* -------------------------------------------------- */

      // Mimic the Rinku and Twitter Text gems

      // https://github.com/gregjacobs/Autolinker.js/

      newUserTextarea.find('p').each(function() {
        var paragraph = $(this),
          link = Autolinker.link(paragraph.html(), { stripPrefix: false });

        if(link) {
          paragraph.html(link);
        }
      });

      /* -------------------------------------------------- */

      // TODO: Make sure posts don't get duplicated by polling

      /* -------------------------------------------------- */

      if(options.formType === 'topic') {
        $.feeds.processPost({
          feedType: 'regular',
          container: newPost,
          insertAfterPageLoad: true
        });
      } else if(options.formType === 'reply') {
        $.feeds.processPost({
          feedType: 'regular',
          container: newPost,
          insertAfterPageLoad: true
        });
      }
    });
  },

  /* -------------------------------------------------- */

  // TODO: https://github.com/jzaefferer/jquery-validation

  resetForm: function(options) {
    var form = options.form;

    // Reset the form to its initial state

    form[0].reset();

    // Empty content

    form.find('input[type=text], input[type=email], input[type=password], textarea').val('');

    /* -------------------------------------------------- */

    if(options.formType === 'topic') {

      // Uncheck checkboxes

      form.find('input[type=checkbox]').prop('checked', false);

      /* -------------------------------------------------- */

      // Reset Selectize

      var selectize = globalVar.formSelect[0].selectize;

      selectize.clear();

      /* -------------------------------------------------- */

      // Remove photos

      form.find('.photos').remove();
    }
  },

  /* -------------------------------------------------- */

  // Corresponds to `posting_photo_editor.js`

  addPhotosToForm: function(form, formData) {
    form.find('.photos .photo').each(function(i, event) {
      var data = $(event).data('data');

      formData.append('original_photos[]', dataURItoBlob(data.imageData.toDataURL()), data.imageName);
      formData.append('processed_photos[]', dataURItoBlob(data.canvasData.toDataURL()), data.canvasName);

      // TODO: Rename to `stack_data`, requires backend work

      formData.append('filter_data[]', JSON.stringify(data.stack));
    });
  },

  /* -------------------------------------------------- */

  prepareTopicComposeForm: function() {
    var form = globalVar.activePage.find('.new_topic form'),
      selectizeInput,
      originalPlaceholder;

    form.find('label').inFieldLabels();

    /* -------------------------------------------------- */

    // TODO: iScroll integration on mobile?

    globalVar.formSelect = form.find('.choose_forum').selectize({
      plugins: ['optgroup_packery'],
      onInitialize: function() {
        selectizeInput = $('.selectize-input').find('input');
        originalPlaceholder = selectizeInput.attr('placeholder');
      },
      onDropdownOpen: function() {

        // Remove content from previous postings

        selectizeInput.parent().find('.item').hide();

        // TODO: I18n

        selectizeInput.attr('placeholder', 'SÃ¸k...');

        // TODO: Remove come 0.12.2 or higher

        selectizeInput.css('width', 'auto');
      },
      onDropdownClose: function() {
        selectizeInput.parent().find('.item').show();

        selectizeInput.attr('placeholder', originalPlaceholder);

        // TODO: Remove come 0.12.2 or higher

        selectizeInput.css('width', 'auto');
      },
      onChange: function(value) {
        var forumType = value.split('|')[1];

        form.find('.email, .password, .start_date, .end_date, .enable_comments, .location, .size, .price, .cats_or_dogs').removeClass('hide').addClass('hide');

        // TODO: I18n

        form.find('label.email').text('Epost');

        if(forumType == 'ad' || forumType == 'event') {
          form.find('.location, .email, .password, .enable_comments').removeClass('hide');
        }

        if(forumType == 'ad') {
          var category = value.split('|')[2];

          if(category == 'housing') {
            form.find('.size, .price, .cats_or_dogs').removeClass('hide');
          } else if(category == 'for_sale') {
            form.find('.size, .price').removeClass('hide');
          }
        } else if(forumType == 'event') {
          form.find('.start_date, .end_date').removeClass('hide');
        }
      }
    });

    /* -------------------------------------------------- */

    $.posting.optimisticPosting({
      form: form,
      formType: 'topic'
    });
  },

  /* -------------------------------------------------- */

  prepareReplyComposeForms: function(form) {
    form.find('label').inFieldLabels();

    /* -------------------------------------------------- */

    var topic = form.closest('.topic'),
      emailField = form.find('.email'),
      newReply = form.closest('.new_reply');

    // Class `post_text` is generated by Simple Form

    form.find('.post_text').on('tap', function(event) {

      // Show email field if ad

      if(topic.data('forum-type') === 'ad') {
        emailField.removeClass('hide');
        newReply.addClass('expanded');
      }
    });

    /* -------------------------------------------------- */

    $.posting.optimisticPosting({
      form: form,
      formType: 'reply'
    });
  }
}

/* -------------------------------------------------- */

// Launch the stuff above

$(document).on('pagecontainershow', function() {
  if(GLOBAL_CONFIG.isRootPath || GLOBAL_CONFIG.isForumShowPath || GLOBAL_CONFIG.isMobileNewPostPath) {
    $.posting.prepareTopicComposeForm();
  }

  /* -------------------------------------------------- */

  // Fetch reply template

  var replyUrl = '/generelt/gi-oss-tilbakemelding';

  $.get(replyUrl, function(html) {
    // console.log('Got the reply');

    globalVar.replyTemplate = $(html).find('.reply').first();

    // Hide form until requested by user

    globalVar.replyTemplate.find('.new_reply').addClass('hide');
  });

  globalVar.activePage.find('.first_post, .reply').each(function() {
    $.posting.prepareReplyComposeForms($(this).find('form'));
  });
});

